{% extends "base.html" %}
{% load url from future %}
{% load typeformat %}
{% load raw %}

{% block style %}
<style>
	.btn-feature {
		padding: 5px;
		margin: 5px;
		min-width: 100px;
		
	}
	#model-score {
		margin:20px;
		margin-top: 10%;
		font-size: 800%;
	}
	
	.score-major {
		
	}
	.score-minor {
		
		font-size: 30%;
	}
	
	
	
	td.success {
		background-color: green;
		color : white;
	}
	td.warning {
		
		
	}
	
	
</style>
{% endblock %}
{% block content %}
	
	<h1>Analysis of {{ name }} <small>Build predictive models and predict data</small></h1>
	
		<div id="message"></div>
	
		  <div class="row-fluid">
			    <div class="span12">
			      	<div class="span7" >
						{% include "analysis/inc_tab.html" %}
					</div>
					<div class="span5">
						<div class="pull-right">
							{% include "analysis/inc_menu_btn.html" %}
						</div>
					</div>
				</div>
			</div>	
			<div class="row-fluid">
				
	
				<div class="span4">
					 {% if ftable.target %}
						<h2>Prediction of <strong id="target-name" class="text-success">{{ ftable.target }}</strong> </h2>
					 {% else %}
					 	<h2>Find clusters</h2>
					 {% endif %}
					 <div id="filter-info"></div>
						<h3>Selected features</h3>
						<div id="features">
						{% for fname,feature in ftable.get_features %}
							{% ifnotequal fname ftable.target %}
								{% if feature.is_usable %}
									<button id="{{ fname|slugify }}" class="btn  btn-info btn-medium btn-feature" onclick="ftcmd.toggle_feature('{{ fname }}',toggle_feature);">{{ fname }}</button>
								{% else %}
									<button id="{{ fname|slugify }}" class="btn btn-medium btn-feature" onclick="ftcmd.toggle_feature('{{ fname }}',toggle_feature);">{{ fname }}</button>
								{% endif %}
							{% endifnotequal %}
						{% endfor %}
						</div>
						
					</div>
				<div class="span6">
					<div id="score" class="hidden">
						<h3>Model accuracy</h3>
						<div id="model-score"><span id="model-score-major" class="score-major"></span><span id="model-score-minor" class="score-minor"></span></div>
					</div>
					<div id="model-output"></div>
				</div>
				<div class="span2">
					<div class="well sidebar-nav" id="saved-model-list">
						<ul  class="nav nav-list">
							<li class="nav-header">Actions</li>
							<li><a href="#" onclick="ftcmd.build_model(current_filter_name,current_filter,update_score); return false;" ><i class="icon-play-circle"></i>Find model</a></li>
							<li><a href="#" onclick="ftcmd.select_best_features(current_filter,select_best_features); return false;" ><i class="icon-random"></i>Find features</a></li>
							<li><a id="btn-add-filter"  href="#add-filter-modal" role="button" data-toggle="modal"><i class="icon-filter"></i>Add filter...</a></li>
							<li><a id="btn-save-model" href="#" onclick="ftcmd.save_model('{{ ftable.target }}',add_saved_model); return false;" ><i class="icon-star-empty"></i>Save model</a></li>
							<li><a id="btn-score-model"  href="#score-model-modal" role="button" data-toggle="modal"><i class="icon-bullhorn"></i>Score models</a></li>
							<li><a id="btn-apply-model"  href="#apply-model-modal" role="button" data-toggle="modal"><i class="icon-retweet"></i>Predict...</a></li>
							
						 <li class="nav-header" id="filter-list">Filters</li>
						  {% for name in ftable.filters.keys %}
						  	<li class="filter-item"><span><a href="#" onclick="select_filter('{{ name }}'); return false;">{{ name }}</a></li>
						  {% endfor %}
						  
						  <li class="nav-header">Saved models</li>
						  {% for model_name, model in ftable.models.items %}
						  	<li><span><a href="#" onclick="ftcmd.get_model_info('{{ model_name }}',set_model_info);">{{ model_name }}</a><a href="#"><i class="icon-remove" onclick="remove_model('{{ model_name }}');"></i></a></span></li>
						  {% endfor %}
						</ul>
					</div>
				</div>	
			</div>
				
				
{% include "analysis/inc_save_popup.html" %}
{% include "analysis/inc_add_feature_popup.html" %}			
{% include "analysis/inc_apply_model_popup.html" %}
{% include "analysis/inc_add_filter_popup.html" %}
{% include "analysis/inc_search_correlation_popup.html" %}


{% raw %}
	<script id="template-confusion-matrix" type="text/dot.js">
		<h3>Confusion matrix</h3>
		<table class="table table-condensed">
		<thead><tr>
		{{~it.model_info.target_class:target_class:i}}
			<th>{{=it.model_info.target}}={{=target_class}}</th>
		{{~}}
		</tr></thead>
		{{~it.model_info.metrics:metric_row:i}}
			<tr>
			{{~metric_row:metric:j}}
				{{?i==j}}
					<td class="success">{{=metric}}</td>
				{{??}}
					<td class="warning">{{=metric}}</td>
				{{?}}
			{{~}}
			</tr>
		{{~}}
		
		</table>
	</script>
	
	<script id="template-best-features" type="text/dot.js">
	<h3>Best features</h3>
	<div id="best-feature-bar"></div>
	</script>
{% endraw %}


{% include "analysis/inc_add_filter_script.html" %}

</div>


{% endblock %}

{% block script %}
<script>
var name = '{{ name }}';
var ftable_name = '{{ dpath }}';
var api_url = '{% url 'api-analysis' %}';
var target_url = '{% url 'summary-analysis' %}?dpath={{ dpath }}';

var ftcmd = new FeatureTableCommand(api_url,ftable_name);

var featureset = null;
var current_target = null;
var current_model_name = null;

var current_filter;
var current_filter_name;

var confusion_matrix_template = doT.template($('#template-confusion-matrix').text());
		

function update_score(model_info) {

	score = model_info.score;
	score = ((score * 100).toFixed(2) + '').split('.');
	
	score_major = score[0];
	score_minor = score[1];
	$('#model-score-major').html(score_major);
	$('#model-score-minor').html('.' + score_minor + '%');
	
	$('#score').removeClass('hidden');
	$('#btn-save-model').removeClass('disabled');
	$('#btn-apply-model').removeClass('disabled');
	
	current_model_name = model_info.name;
	current_target = model_info.target;
	
	if(model_info.model_type == 'CLAS' && model_info.metrics != null) {
	
		$('#model-output').html(confusion_matrix_template({ 'model_info':model_info}));
		$('#model-output').height(100 * model_info.metrics.length);
	}
	else {
		$('#score').addClass('hidden');
		$('#model-output').html('');
	}
	
	if (model_info.filter != null) {
		$('#filter-info').html('<div class="alert alert-info"><strong>Filter : ' + model_info.filter_name + '</strong><button class="pull-right btn btn-mini btn-info" onclick="clear_filter();">Clear filter</button><br/><br/><pre>' + model_info.filter + '</pre></div>');
		current_filter = model_info.filter;
		current_filter_name = model_info.filter_name;
	}
	else {
		$('#filter-info').html('');
		current_filter = undefined;
		current_filter_name = undefined;
	}
		
	
	
	
}

function toggle_feature(fname,use) {
	if (use) {
		$('#' + fname.toLowerCase().replace(' ','-')).addClass('btn-info');
	}
	else {
		$('#' + fname.toLowerCase().replace(' ','-')).removeClass('btn-info');
	}
	
}

function set_model_info(model_info) {

	update_score(model_info);
	
	feature_btns = $('#features').children();
	$.each(feature_btns, function(i) {
		selected_feature_btns = $.map(model_info.selected_features, function(f) {
			return f.replace(' ','-');
		});
		if (selected_feature_btns.indexOf(feature_btns[i].id) >=0) {
			$('#'+feature_btns[i].id).addClass('btn-info');
		}
		else {
			$('#'+feature_btns[i].id).removeClass('btn-info');
		}
	
	});
	
	
	$('#target-name').html(model_info.target);
	
	
}

function add_saved_model(name) {
	document.location.reload();
}

function select_best_features(kbest) {
	$('#score').addClass('hidden');
		
	$('#model-output').html($('#template-best-features').text());
	categories = [];
	data=[];
	$.each(kbest, function (i) {
		categories.push(kbest[i][0]);
		data.push(kbest[i][1]);
	});
	
	options = {
		'categories' : categories,
		'series' : [{'name' : 'Feature score', 'data' : data}]
		};
	
	draw_bar('Feature score',options,'best-feature-bar','','Score',0,true);
	$('#model-output').height('auto');
	$('#model-output').height($('#model-output').height()+100);
}

$('#apply-model-modal').on('show', function () {
	$('#input-filename').val(ftable_name.replace(name,'test.csv'));
	$('#output-filename').val(ftable_name.replace(name,'predictions.csv'));
});



ftcmd.get_current_model_info(update_score);

function remove_model(model_name) {
	ftcmd.remove_model(model_name, function() {
		window.location.reload();
	});
}


</script>


{% endblock %}